<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <img id="ScreenCapture" />
    <button id="connect">連線</button>
    <span id="socketEvent"></span>
  </body>
  <script type="text/javascript">
    const socketEvent = document.getElementById("socketEvent");
    const screenCapture = document.getElementById("ScreenCapture");

    const frameBuffer = [];
    setInterval(function () {
      if (frameBuffer.length <= 0) return;
      screenCapture.src = frameBuffer.shift();
    }, 10);
    // 創建一個新的WebSocket物件
    var socket = InitialWS();

    document
      .getElementById("connect")
      .addEventListener("click", function (event) {
        if (socket.readyState == 0 || socket.readyState == 1) return;
        socketEvent.innerText = "連接中...";
        socket = InitialWS();
      });
    //讀取輸入
    screenCapture.addEventListener("click", function (event) {
      MouseEvent(event, 1);
    });

    screenCapture.addEventListener("dblclick", function (event) {
      MouseEvent(event, 3);
    });

    screenCapture.addEventListener("contextmenu", function (event) {
      event.preventDefault();
      MouseEvent(event, 2);
    });

    document.addEventListener("keydown", function (event) {
      event.preventDefault();
      MouseEvent(event, 4);
    });

    screenCapture.addEventListener("mousemove", function (event) {
      MouseEvent(event, 5);
    });

    function MouseEvent(event, type) {
      const data = {
        Type: type,
        X: event.x - screenCapture.x,
        Y: event.y - screenCapture.y,
        Key: event.keyCode,
      };
      var jsonData = JSON.stringify(data);
      sendMessage(jsonData);
    }

    // 發送訊息到伺服器
    function sendMessage(message) {
      socket.send(message);
    }

    // 關閉連接
    function closeConnection() {
      socket.close();
    }

    // 初始化ws
    function InitialWS() {
      const socket = new WebSocket("ws://192.168.0.17:8080");

      // 連接開啟
      socket.addEventListener("open", function (event) {
        console.log("連接到WebSocket伺服器");
        socketEvent.innerText = "連接到WebSocket伺服器";
      });

      socket.addEventListener("close", function (event) {
        console.log("連接已關閉");
        socketEvent.innerText = "連接已關閉";
      });

      // 聆聽訊息
      socket.addEventListener("message", function (event) {
        console.log("來自伺服器的訊息");
        const base64_img = `data:image/png;base64,${event.data}`;
        frameBuffer.push(base64_img);
      });

      socket.addEventListener("error", function (event) {
        console.log("連線出現錯誤", event);
        socketEvent.innerText = "連線出現錯誤";
      });
      return socket;
    }
  </script>
</html>
