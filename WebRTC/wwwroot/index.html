<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <img id="ScreenCapture" />
    <hr />
    <div>
      <label>請輸入建立WebSocket連線的 IP:Port</label>
      <input type="text" id="url" />
      <input type="submit" onclick="connect()" value="連線" />
    </div>
    <div id="socketEvent"></div>
  </body>
  <script type="text/javascript">
    const socketEvent = document.getElementById("socketEvent");
    const screenCapture = document.getElementById("ScreenCapture");

    // const frameBuffer = [];
    // setInterval(function () {
    //   if (frameBuffer.length <= 0) return;
    //   screenCapture.src = frameBuffer.shift();
    // }, 10);
    // 創建一個新的WebSocket物件
    let socket;
    const url = document.getElementById("url");

    function connect() {
      if (socket != null && (socket.readyState == 0 || socket.readyState == 1))
        return;
      socketEvent.innerText = "連接中...";
      socket = InitialWS();
    }

    // 初始化ws
    function InitialWS() {
      console.log(`準備連線至ws://${url.value}`);
      const socket = new WebSocket(`ws://${url.value}`);
      //socket.binaryType = "arraybuffer";

      // 連接開啟
      socket.addEventListener("open", function (event) {
        console.log("連接到WebSocket伺服器");
        socketEvent.innerText = "連接到WebSocket伺服器";
      });

      socket.addEventListener("close", function (event) {
        console.log("連接已關閉");
        socketEvent.innerText = "連接已關閉";
      });

      // 聆聽訊息
      socket.addEventListener("message", function (event) {
        console.log("來自伺服器的訊息");
        //const base64_img = `data:image/jpg;base64,${event.data}`;
        //frameBuffer.push(base64_img);
        //console.log(frameBuffer.length);

        const arrayBuffer = event.data;
        // 將 arrayBuffer 轉換為 Blob
        const blob = new Blob([arrayBuffer], { type: "image/jpg" });
        displayImage(blob);
      });

      socket.addEventListener("error", function (event) {
        console.log("連線出現錯誤", event);
        socketEvent.innerText = "連線出現錯誤";
      });

      //讀取輸入
      screenCapture.addEventListener("click", function (event) {
        MouseEvent(event, 1);
      });

      screenCapture.addEventListener("dblclick", function (event) {
        MouseEvent(event, 3);
      });

      screenCapture.addEventListener("contextmenu", function (event) {
        event.preventDefault();
        MouseEvent(event, 2);
      });

      document.addEventListener("keydown", function (event) {
        event.preventDefault();
        MouseEvent(event, 4);
      });

      screenCapture.addEventListener("mousemove", function (event) {
        //MouseEvent(event, 5);
      });

      function MouseEvent(event, type) {
        const data = {
          Type: type,
          X: event.x - screenCapture.x,
          Y: event.y - screenCapture.y,
          Key: event.keyCode,
        };
        var jsonData = JSON.stringify(data);
        sendMessage(jsonData);
      }

      // 發送訊息到伺服器
      function sendMessage(message) {
        socket.send(message);
      }

      // 關閉連接
      function closeConnection() {
        socket.close();
      }
      return socket;
    }

    function displayImage(blob) {
      // 創建 Blob URL
      const url = URL.createObjectURL(blob);
      // 將 Blob URL 設定到 img 標籤的 src 屬性
      screenCapture.src = url;

      // 設置定時器，釋放 Blob URL 資源
      setTimeout(() => URL.revokeObjectURL(url), 50); // 50毫秒後釋放資源
    }
  </script>
</html>
